name: CI/CD Docker Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. GitHub ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      # 3. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ - gateway-service
#      - name: Build & Push gateway-service
#        # working-directory: ./msa-gateway-service
#        run: |
#
#          # resources ë””ë ‰í† ë¦¬ê°€ ì—†ì„ ê²½ìš° ìƒì„±
#          mkdir -p src/main/resources
#
#          # GitHub Secretsì— ë“±ë¡í•œ application.yml ë‚´ìš©ì„ ë³µì‚¬
#          echo "${{ secrets.GATEWAY_APPLICATION_YML }}" | base64 -d > src/main/resources/application.yml
#
#          # ë””ì½”ë”©ëœ application.yml í™•ì¸
#          echo "application.yml ë‚´ìš©:"
#          cat src/main/resources/application.yml
#
#          docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/gateway-service:${{ github.sha }} .
#          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/gateway-service:${{ github.sha }}

      - name: Build & Push gateway-service (with retry)
        run: |
          mkdir -p src/main/resources 
          
          echo "${{ secrets.GATEWAY_APPLICATION_YML }}" | base64 -d > src/main/resources/application.yml
          
          echo "application.yml ë‚´ìš©:"
          cat src/main/resources/application.yml
      
          docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/gateway-service:${{ github.sha }} .
      
          for i in {1..3}; do
            docker push ${{ secrets.DOCKER_HUB_USERNAME }}/gateway-service:${{ github.sha }} && break || sleep 5
          done


      # 4. EC2ì— SSH ì ‘ì† & ë°°í¬
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/vybz/gateway-service
            
            export GATEWAY_IMAGE_TAG=${{ github.sha }}
            docker-compose down
            docker-compose rm -f
            
            docker images "${{ secrets.DOCKER_HUB_USERNAME }}/gateway-service" --format "{{.ID}}" | uniq | tail -n +2 | xargs -r docker rmi -f
            
            docker image prune -af
            
            docker-compose pull gateway
            docker-compose up -d gateway

      # 5-1. ì„±ê³µ ì‹œ ì•Œë¦¼
      - name: Send Discord Success Notification
        if: success()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_BACK }}
        with:
          args: |
            âœ… [${{ github.actor }}]ë‹˜ì´ `${{ github.repository }}` ë ˆí¬ì§€í† ë¦¬ì—ì„œ **ë°°í¬ë¥¼ ì™„ë£Œ**í–ˆì–´ìš”!
            ğŸ”— ì»¤ë°‹: ${{ github.sha }}

      # 5-2. ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
      - name: Send Discord Failure Notification
        if: failure()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_BACK }}
        with:
          args: |
            âŒ [${{ github.actor }}]ë‹˜ì´ `${{ github.repository }}` ë ˆí¬ì§€í† ë¦¬ì—ì„œ **ë°°í¬ì— ì‹¤íŒ¨**í–ˆì–´ìš”!
            ğŸ” ì—ëŸ¬ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.